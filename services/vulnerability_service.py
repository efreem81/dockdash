"""
Vulnerability Service - Image Security Scanning
Uses Trivy to scan Docker images for CVEs and vulnerabilities
"""
import json
import subprocess
import shutil
import time
from typing import Optional, Dict, Any

# Cache for scan results (image -> (timestamp, results))
_scan_cache: Dict[str, tuple] = {}
CACHE_TTL = 3600  # 1 hour


def _cache_get(key: str) -> Optional[Dict]:
    """Get cached scan result if not expired."""
    entry = _scan_cache.get(key)
    if not entry:
        return None
    ts, value = entry
    if (time.time() - ts) > CACHE_TTL:
        _scan_cache.pop(key, None)
        return None
    return value


def _cache_set(key: str, value: Dict):
    """Cache scan result."""
    _scan_cache[key] = (time.time(), value)


def is_trivy_available() -> bool:
    """Check if Trivy is installed and available."""
    return shutil.which('trivy') is not None


def scan_image(image_ref: str, severity_filter: str = "CRITICAL,HIGH") -> Dict[str, Any]:
    """
    Scan a Docker image for vulnerabilities using Trivy.
    
    Args:
        image_ref: Docker image reference (e.g., 'nginx:latest')
        severity_filter: Comma-separated severity levels (CRITICAL,HIGH,MEDIUM,LOW)
    
    Returns:
        Dictionary with scan results including vulnerabilities found
    """
    result = {
        'image': image_ref,
        'success': False,
        'scanner': 'trivy',
        'vulnerabilities': [],
        'summary': {
            'critical': 0,
            'high': 0,
            'medium': 0,
            'low': 0,
            'unknown': 0,
            'total': 0
        },
        'error': None
    }
    
    if not image_ref or image_ref == 'unknown':
        result['error'] = 'Invalid image reference'
        return result
    
    # Check cache first
    cache_key = f"{image_ref}:{severity_filter}"
    cached = _cache_get(cache_key)
    if cached:
        return cached
    
    if not is_trivy_available():
        result['error'] = 'Trivy scanner not installed. Install with: brew install trivy (macOS) or see https://trivy.dev'
        return result
    
    try:
        # Run Trivy scan with JSON output
        cmd = [
            'trivy', 'image',
            '--format', 'json',
            '--severity', severity_filter,
            '--quiet',
            image_ref
        ]
        
        proc = subprocess.run(
            cmd,
            capture_output=True,
            text=True,
            timeout=300  # 5 minute timeout
        )
        
        if proc.returncode != 0 and not proc.stdout:
            result['error'] = proc.stderr or 'Trivy scan failed'
            return result
        
        # Parse Trivy JSON output
        scan_data = json.loads(proc.stdout) if proc.stdout else {}
        
        # Extract vulnerabilities from results
        vulnerabilities = []
        summary = {'critical': 0, 'high': 0, 'medium': 0, 'low': 0, 'unknown': 0, 'total': 0}
        
        results_list = scan_data.get('Results', [])
        for target in results_list:
            target_name = target.get('Target', 'unknown')
            target_type = target.get('Type', 'unknown')
            
            for vuln in target.get('Vulnerabilities', []) or []:
                severity = vuln.get('Severity', 'UNKNOWN').lower()
                
                vuln_entry = {
                    'id': vuln.get('VulnerabilityID', ''),
                    'package': vuln.get('PkgName', ''),
                    'version': vuln.get('InstalledVersion', ''),
                    'fixed_version': vuln.get('FixedVersion', ''),
                    'severity': severity.upper(),
                    'title': vuln.get('Title', ''),
                    'description': vuln.get('Description', '')[:200] if vuln.get('Description') else '',
                    'target': target_name,
                    'type': target_type,
                    'cvss_score': _extract_cvss_score(vuln),
                    'references': vuln.get('References', [])[:3]  # Limit references
                }
                vulnerabilities.append(vuln_entry)
                
                if severity in summary:
                    summary[severity] += 1
                else:
                    summary['unknown'] += 1
                summary['total'] += 1
        
        result['success'] = True
        result['vulnerabilities'] = vulnerabilities
        result['summary'] = summary
        result['scanned_at'] = time.strftime('%Y-%m-%d %H:%M:%S')
        
        # Cache successful results
        _cache_set(cache_key, result)
        
    except subprocess.TimeoutExpired:
        result['error'] = 'Scan timed out after 5 minutes'
    except json.JSONDecodeError as e:
        result['error'] = f'Failed to parse scan results: {e}'
    except Exception as e:
        result['error'] = str(e)
    
    return result


def _extract_cvss_score(vuln: Dict) -> Optional[float]:
    """Extract CVSS score from vulnerability data."""
    # Try CVSS v3 first, then v2
    cvss = vuln.get('CVSS', {})
    for source in cvss.values():
        if 'V3Score' in source:
            return source['V3Score']
        if 'V2Score' in source:
            return source['V2Score']
    return None


def scan_multiple_images(image_refs: list, severity_filter: str = "CRITICAL,HIGH") -> Dict[str, Any]:
    """Scan multiple images and return aggregated results."""
    results = {}
    total_summary = {'critical': 0, 'high': 0, 'medium': 0, 'low': 0, 'unknown': 0, 'total': 0}
    
    for image_ref in image_refs[:10]:  # Limit to 10 images
        scan_result = scan_image(image_ref, severity_filter)
        results[image_ref] = scan_result
        
        if scan_result.get('success'):
            for key in total_summary:
                total_summary[key] += scan_result['summary'].get(key, 0)
    
    return {
        'success': True,
        'results': results,
        'total_summary': total_summary,
        'images_scanned': len(results)
    }


def get_vulnerability_report(image_ref: str) -> Dict[str, Any]:
    """Get a formatted vulnerability report for an image."""
    scan = scan_image(image_ref)
    
    if not scan['success']:
        return scan
    
    # Group vulnerabilities by severity
    by_severity = {'CRITICAL': [], 'HIGH': [], 'MEDIUM': [], 'LOW': [], 'UNKNOWN': []}
    
    for vuln in scan['vulnerabilities']:
        sev = vuln['severity']
        if sev in by_severity:
            by_severity[sev].append(vuln)
        else:
            by_severity['UNKNOWN'].append(vuln)
    
    scan['by_severity'] = by_severity
    scan['has_critical'] = len(by_severity['CRITICAL']) > 0
    scan['has_high'] = len(by_severity['HIGH']) > 0
    scan['needs_attention'] = scan['has_critical'] or scan['has_high']
    
    return scan


def clear_cache():
    """Clear the vulnerability scan cache."""
    global _scan_cache
    _scan_cache = {}
    return {'success': True, 'message': 'Cache cleared'}
