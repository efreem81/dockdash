{% extends "base.html" %}

{% block title %}Settings - DockDash{% endblock %}

{% block content %}
<div class="settings-page">
    <div class="page-header">
        <h1>âš™ï¸ Settings</h1>
    </div>

    <!-- Tab Navigation -->
    <div class="settings-tabs">
        <button class="tab-btn active" onclick="showSettingsTab('notifications')">ğŸ”” Notifications</button>
        <button class="tab-btn" onclick="showSettingsTab('security')">ğŸ›¡ï¸ Security Scanning</button>
        <button class="tab-btn" onclick="showSettingsTab('monitoring')">ğŸ“Š Monitoring</button>
        <button class="tab-btn" onclick="showSettingsTab('maintenance')">ğŸ§¹ Maintenance</button>
        <button class="tab-btn" onclick="showSettingsTab('account')">ğŸ‘¤ Account</button>
    </div>

    <!-- Notifications Tab -->
    <div class="settings-tab-content" id="tab-notifications">
        <div class="settings-section">
            <div class="section-header">
                <h2>ğŸ”” Webhook Notifications</h2>
                <p class="section-desc">Get alerted when containers stop, become unhealthy, or exceed resource thresholds.</p>
            </div>
            
            <div class="webhooks-list" id="webhooksList">
                <div class="loading">Loading webhooks...</div>
            </div>

            <button class="btn btn-primary" onclick="showAddWebhook()">
                â• Add Webhook
            </button>
        </div>
    </div>

    <!-- Security Scanning Tab -->
    <div class="settings-tab-content" id="tab-security" style="display: none;">
        <div class="settings-section">
            <div class="section-header">
                <h2>ğŸ›¡ï¸ Vulnerability Scanning</h2>
                <p class="section-desc">Scan container images for known CVEs using Trivy. Results appear on the Dashboard.</p>
            </div>

            <!-- Scanner Status -->
            <div class="status-card" id="scannerStatusCard">
                <div class="status-indicator" id="scannerIndicator">â³</div>
                <div class="status-info">
                    <strong id="scannerStatusText">Checking scanner...</strong>
                    <span class="status-detail" id="lastScanInfo"></span>
                </div>
            </div>

            <!-- Scan Now -->
            <div class="action-card">
                <div class="action-info">
                    <h3>ğŸ” Scan All Container Images</h3>
                    <p>Immediately scan all images from running containers for vulnerabilities.</p>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary btn-lg" onclick="runFullScan()" id="fullScanBtn">
                        â–¶ï¸ Scan Now
                    </button>
                </div>
                <div class="scan-progress" id="scanProgress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="scanProgressFill"></div>
                    </div>
                    <span class="progress-text" id="scanProgressText">Scanning...</span>
                </div>
            </div>

            <!-- Schedule Settings -->
            <div class="settings-card">
                <h3>â° Scheduled Scanning</h3>
                <p class="card-desc">Automatically scan all container images on a schedule.</p>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="toggle-label">
                            <input type="checkbox" id="scanEnabled" onchange="updateScanSchedule()">
                            <span>Enable scheduled scanning</span>
                        </label>
                    </div>
                </div>

                <div class="form-row" id="scheduleOptions">
                    <div class="form-group">
                        <label for="scheduleType">Frequency</label>
                        <select id="scheduleType" onchange="updateScheduleUI()">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                        </select>
                    </div>
                    <div class="form-group" id="dayGroup" style="display: none;">
                        <label for="scheduleDay">Day</label>
                        <select id="scheduleDay">
                            <option value="0">Monday</option>
                            <option value="1">Tuesday</option>
                            <option value="2">Wednesday</option>
                            <option value="3">Thursday</option>
                            <option value="4">Friday</option>
                            <option value="5">Saturday</option>
                            <option value="6">Sunday</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="scheduleHour">Time</label>
                        <div class="time-input">
                            <input type="number" id="scheduleHour" min="0" max="23" value="3" class="time-part">
                            <span>:</span>
                            <input type="number" id="scheduleMinute" min="0" max="59" value="0" class="time-part">
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="severityFilter">Severity Filter</label>
                        <select id="severityFilter">
                            <option value="CRITICAL,HIGH,MEDIUM,LOW">All (Critical, High, Medium, Low)</option>
                            <option value="CRITICAL,HIGH,MEDIUM">Critical, High, Medium</option>
                            <option value="CRITICAL,HIGH">Critical, High only</option>
                            <option value="CRITICAL">Critical only</option>
                        </select>
                    </div>
                </div>

                <button class="btn btn-secondary" onclick="saveScanSettings()">
                    ğŸ’¾ Save Schedule
                </button>
            </div>
        </div>
    </div>

    <!-- Monitoring Tab -->
    <div class="settings-tab-content" id="tab-monitoring" style="display: none;">
        <div class="settings-section">
            <div class="section-header">
                <h2>ğŸ“Š Resource Monitoring</h2>
                <p class="section-desc">Monitor container CPU and memory usage. Get alerts when thresholds are exceeded.</p>
            </div>

            <!-- Monitoring Status -->
            <div class="status-card">
                <div class="status-indicator" id="monitoringIndicator">â¸ï¸</div>
                <div class="status-info">
                    <strong id="monitoringStatusText">Loading...</strong>
                </div>
                <div class="status-actions">
                    <button class="btn btn-success" id="startMonitoringBtn" onclick="startMonitoring()">
                        â–¶ï¸ Start
                    </button>
                    <button class="btn btn-warning" id="stopMonitoringBtn" onclick="stopMonitoring()" style="display: none;">
                        â¹ï¸ Stop
                    </button>
                </div>
            </div>

            <!-- Thresholds -->
            <div class="settings-card">
                <h3>âš ï¸ Alert Thresholds</h3>
                <p class="card-desc">Send alerts when containers exceed these resource limits.</p>
                
                <div class="form-row threshold-row">
                    <div class="form-group">
                        <label for="cpuThreshold">CPU Alert Threshold</label>
                        <div class="input-with-suffix">
                            <input type="number" id="cpuThreshold" value="80" min="0" max="100">
                            <span class="suffix">%</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="memoryThreshold">Memory Alert Threshold</label>
                        <div class="input-with-suffix">
                            <input type="number" id="memoryThreshold" value="85" min="0" max="100">
                            <span class="suffix">%</span>
                        </div>
                    </div>
                </div>

                <button class="btn btn-secondary" onclick="updateThresholds()">
                    ğŸ’¾ Save Thresholds
                </button>
            </div>
        </div>
    </div>

    <!-- Maintenance Tab -->
    <div class="settings-tab-content" id="tab-maintenance" style="display: none;">
        <div class="settings-section">
            <div class="section-header">
                <h2>ğŸ§¹ System Maintenance</h2>
                <p class="section-desc">Clean up unused Docker resources to free disk space.</p>
            </div>

            <div class="maintenance-grid">
                <div class="maintenance-card">
                    <div class="maintenance-icon">ğŸ“¦</div>
                    <h3>Stopped Containers</h3>
                    <p>Remove all stopped containers</p>
                    <button class="btn btn-warning" onclick="pruneContainers()">
                        ğŸ—‘ï¸ Prune Containers
                    </button>
                </div>

                <div class="maintenance-card">
                    <div class="maintenance-icon">ğŸ–¼ï¸</div>
                    <h3>Unused Images</h3>
                    <p>Remove dangling and unused images</p>
                    <button class="btn btn-warning" onclick="pruneImages()">
                        ğŸ—‘ï¸ Prune Images
                    </button>
                </div>

                <div class="maintenance-card">
                    <div class="maintenance-icon">ğŸ’¾</div>
                    <h3>Unused Volumes</h3>
                    <p>Remove unused volumes (data loss possible!)</p>
                    <button class="btn btn-danger" onclick="pruneVolumes()">
                        ğŸ—‘ï¸ Prune Volumes
                    </button>
                </div>

                <div class="maintenance-card maintenance-card-full">
                    <div class="maintenance-icon">ğŸ§¹</div>
                    <h3>Full System Cleanup</h3>
                    <p>Remove all unused containers, images, and volumes at once</p>
                    <button class="btn btn-danger btn-lg" onclick="pruneAll()">
                        ğŸ§¹ Prune Everything
                    </button>
                </div>
            </div>

            <!-- Images Browser -->
            <div class="settings-card">
                <h3>ğŸ“¦ Image Browser</h3>
                <p class="card-desc">View and manage Docker images on this host.</p>
                <button class="btn btn-secondary" onclick="showImagesModal()">
                    ğŸ“¦ View Images
                </button>
            </div>
        </div>
    </div>

    <!-- Account Tab -->
    <div class="settings-tab-content" id="tab-account" style="display: none;">
        <div class="settings-section">
            <div class="section-header">
                <h2>ğŸ‘¤ Account Settings</h2>
            </div>

            <div class="settings-card">
                <div class="account-info">
                    <div class="avatar">{{ current_user.username[0]|upper }}</div>
                    <div class="user-details">
                        <strong>{{ current_user.username }}</strong>
                        <span class="user-meta">Account created {{ current_user.created_at.strftime('%B %d, %Y') if current_user.created_at else 'N/A' }}</span>
                    </div>
                </div>
                
                <a href="{{ url_for('auth.change_password') }}" class="btn btn-secondary">
                    ğŸ” Change Password
                </a>
            </div>
        </div>
    </div>

    <!-- Webhook Modal -->
    <div class="modal-overlay" id="webhookModal" style="display: none;" onclick="closeWebhookModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title" id="webhookModalTitle">â• Add Webhook</div>
                <button class="modal-close" onclick="closeWebhookModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="webhookId">
                
                <div class="form-group">
                    <label for="webhookName">Name</label>
                    <input type="text" id="webhookName" placeholder="e.g., Production Alerts" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="webhookType">Platform</label>
                        <select id="webhookType">
                            <option value="discord">Discord</option>
                            <option value="slack">Slack</option>
                            <option value="telegram">Telegram</option>
                            <option value="generic">Generic Webhook</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="webhookUrl">Webhook URL</label>
                    <input type="url" id="webhookUrl" placeholder="https://..." required>
                    <span class="form-hint">Discord: Settings â†’ Integrations â†’ Webhooks</span>
                </div>
                
                <h4>Alert Triggers</h4>
                <div class="checkbox-grid">
                    <label class="checkbox-card">
                        <input type="checkbox" id="alertStop" checked>
                        <span class="checkbox-label">
                            <span class="checkbox-icon">â¹ï¸</span>
                            Container stopped
                        </span>
                    </label>
                    <label class="checkbox-card">
                        <input type="checkbox" id="alertStart">
                        <span class="checkbox-label">
                            <span class="checkbox-icon">â–¶ï¸</span>
                            Container started
                        </span>
                    </label>
                    <label class="checkbox-card">
                        <input type="checkbox" id="alertHealth" checked>
                        <span class="checkbox-label">
                            <span class="checkbox-icon">â¤ï¸</span>
                            Health check failed
                        </span>
                    </label>
                </div>
                
                <h4>Resource Alerts</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="alertCpu">CPU threshold</label>
                        <div class="input-with-suffix">
                            <input type="number" id="alertCpu" value="90" min="0" max="100">
                            <span class="suffix">%</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="alertMemory">Memory threshold</label>
                        <div class="input-with-suffix">
                            <input type="number" id="alertMemory" value="90" min="0" max="100">
                            <span class="suffix">%</span>
                        </div>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="testWebhook()">ğŸ§ª Test</button>
                    <button class="btn btn-primary" onclick="saveWebhook()">ğŸ’¾ Save Webhook</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Images Modal -->
    <div class="modal-overlay" id="imagesModal" style="display: none;" onclick="closeImagesModal(event)">
        <div class="modal modal-lg" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title">ğŸ“¦ Docker Images</div>
                <button class="modal-close" onclick="closeImagesModal()">Ã—</button>
            </div>
            <div class="modal-body" id="imagesContent">
                <div class="loading">Loading images...</div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/settings.js') }}"></script>
{% endblock %}
