{% extends "base.html" %}

{% block title %}Settings - DockDash{% endblock %}

{% block content %}
<div class="settings-page">
    <div class="page-header">
        <h1>‚öôÔ∏è Settings</h1>
    </div>

    <!-- Tab Navigation -->
    <div class="settings-tabs">
        <button class="tab-btn active" onclick="showSettingsTab('notifications')">üîî Notifications</button>
        <button class="tab-btn" onclick="showSettingsTab('updates')">‚¨ÜÔ∏è Update Checks</button>
        <button class="tab-btn" onclick="showSettingsTab('security')">üõ°Ô∏è Security Scanning</button>
        <button class="tab-btn" onclick="showSettingsTab('monitoring')">üìä Monitoring</button>
        <button class="tab-btn" onclick="showSettingsTab('maintenance')">üßπ Maintenance</button>
        <button class="tab-btn" onclick="showSettingsTab('account')">üë§ Account</button>
    </div>

    <!-- Notifications Tab -->
    <div class="settings-tab-content" id="tab-notifications">
        <div class="settings-section">
            <div class="section-header">
                <h2>üîî Webhook Notifications</h2>
                <p class="section-desc">Get alerted when containers stop, become unhealthy, or exceed resource thresholds.</p>
            </div>
            
            <div class="webhooks-list" id="webhooksList">
                <div class="loading">Loading webhooks...</div>
            </div>

            <button class="btn btn-primary" onclick="showAddWebhook()">
                ‚ûï Add Webhook
            </button>
        </div>
    </div>

    <!-- Update Checks Tab -->
    <div class="settings-tab-content" id="tab-updates" style="display: none;">
        <div class="settings-section">
            <div class="section-header">
                <h2>‚¨ÜÔ∏è Image Update Checks</h2>
                <p class="section-desc">Automatically check if container images have newer versions available in the registry.</p>
            </div>

            <!-- Last Check Status -->
            <div class="status-card" id="updateCheckStatusCard">
                <div class="status-indicator" id="updateCheckIndicator">‚è≥</div>
                <div class="status-info">
                    <strong id="updateCheckStatusText">Loading...</strong>
                    <span class="status-detail" id="lastUpdateCheckInfo"></span>
                </div>
            </div>

            <!-- Manual Check -->
            <div class="settings-card">
                <h3>üîç Manual Check</h3>
                <p class="card-desc">Check all container images for updates right now.</p>
                <button class="btn btn-primary" onclick="runUpdateCheck()" id="runUpdateCheckBtn">
                    ‚¨ÜÔ∏è Check for Updates Now
                </button>
            </div>

            <!-- Schedule Settings -->
            <div class="settings-card">
                <h3>‚è∞ Scheduled Update Checks</h3>
                <p class="card-desc">Automatically check for image updates on a schedule.</p>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="toggle-label">
                            <input type="checkbox" id="updateCheckEnabled" onchange="updateUpdateSchedule()">
                            <span>Enable scheduled update checks</span>
                        </label>
                    </div>
                </div>

                <div class="form-row" id="updateScheduleOptions">
                    <div class="form-group">
                        <label for="updateScheduleType">Frequency</label>
                        <select id="updateScheduleType" onchange="updateUpdateScheduleUI()">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                        </select>
                    </div>
                    <div class="form-group" id="updateDayGroup" style="display: none;">
                        <label for="updateScheduleDay">Day</label>
                        <select id="updateScheduleDay">
                            <option value="0">Monday</option>
                            <option value="1">Tuesday</option>
                            <option value="2">Wednesday</option>
                            <option value="3">Thursday</option>
                            <option value="4">Friday</option>
                            <option value="5">Saturday</option>
                            <option value="6">Sunday</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="updateScheduleHour">Time</label>
                        <div class="time-input">
                            <input type="number" id="updateScheduleHour" min="0" max="23" value="4" class="time-part">
                            <span>:</span>
                            <input type="number" id="updateScheduleMinute" min="0" max="59" value="0" class="time-part">
                        </div>
                    </div>
                </div>

                <button class="btn btn-secondary" onclick="saveUpdateSettings()">
                    üíæ Save Schedule
                </button>
            </div>
        </div>
    </div>

    <!-- Security Scanning Tab -->
    <div class="settings-tab-content" id="tab-security" style="display: none;">
        <div class="settings-section">
            <div class="section-header">
                <h2>üõ°Ô∏è Vulnerability Scanning</h2>
                <p class="section-desc">Scan container images for known CVEs using Trivy. Results appear on the Dashboard.</p>
            </div>

            <!-- Scanner Status -->
            <div class="status-card" id="scannerStatusCard">
                <div class="status-indicator" id="scannerIndicator">‚è≥</div>
                <div class="status-info">
                    <strong id="scannerStatusText">Checking scanner...</strong>
                    <span class="status-detail" id="lastScanInfo"></span>
                </div>
            </div>

            <!-- Scan Now -->
            <div class="action-card">
                <div class="action-info">
                    <h3>üîç Scan All Container Images</h3>
                    <p>Immediately scan all images from running containers for vulnerabilities.</p>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary btn-lg" onclick="runFullScan()" id="fullScanBtn">
                        ‚ñ∂Ô∏è Scan Now
                    </button>
                </div>
                <div class="scan-progress" id="scanProgress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="scanProgressFill"></div>
                    </div>
                    <span class="progress-text" id="scanProgressText">Scanning...</span>
                </div>
            </div>

            <!-- Schedule Settings -->
            <div class="settings-card">
                <h3>‚è∞ Scheduled Scanning</h3>
                <p class="card-desc">Automatically scan all container images on a schedule.</p>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="toggle-label">
                            <input type="checkbox" id="scanEnabled" onchange="updateScanSchedule()">
                            <span>Enable scheduled scanning</span>
                        </label>
                    </div>
                </div>

                <div class="form-row" id="scheduleOptions">
                    <div class="form-group">
                        <label for="scheduleType">Frequency</label>
                        <select id="scheduleType" onchange="updateScheduleUI()">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                        </select>
                    </div>
                    <div class="form-group" id="dayGroup" style="display: none;">
                        <label for="scheduleDay">Day</label>
                        <select id="scheduleDay">
                            <option value="0">Monday</option>
                            <option value="1">Tuesday</option>
                            <option value="2">Wednesday</option>
                            <option value="3">Thursday</option>
                            <option value="4">Friday</option>
                            <option value="5">Saturday</option>
                            <option value="6">Sunday</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="scheduleHour">Time</label>
                        <div class="time-input">
                            <input type="number" id="scheduleHour" min="0" max="23" value="3" class="time-part">
                            <span>:</span>
                            <input type="number" id="scheduleMinute" min="0" max="59" value="0" class="time-part">
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="severityFilter">Severity Filter</label>
                        <select id="severityFilter">
                            <option value="CRITICAL,HIGH,MEDIUM,LOW">All (Critical, High, Medium, Low)</option>
                            <option value="CRITICAL,HIGH,MEDIUM">Critical, High, Medium</option>
                            <option value="CRITICAL,HIGH">Critical, High only</option>
                            <option value="CRITICAL">Critical only</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="logLevel">Log Level</label>
                        <select id="logLevel">
                            <option value="ERROR">Error only</option>
                            <option value="WARNING">Warning</option>
                            <option value="INFO" selected>Info (default)</option>
                            <option value="DEBUG">Debug (verbose)</option>
                        </select>
                        <span class="form-hint">View logs with: docker logs &lt;container&gt;</span>
                    </div>
                </div>

                <button class="btn btn-secondary" onclick="saveScanSettings()">
                    üíæ Save Schedule
                </button>
            </div>
        </div>
    </div>

    <!-- Monitoring Tab -->
    <div class="settings-tab-content" id="tab-monitoring" style="display: none;">
        <div class="settings-section">
            <div class="section-header">
                <h2>üìä Resource Monitoring</h2>
                <p class="section-desc">Monitor container CPU and memory usage. Get alerts when thresholds are exceeded.</p>
            </div>

            <!-- Monitoring Status -->
            <div class="status-card">
                <div class="status-indicator" id="monitoringIndicator">‚è∏Ô∏è</div>
                <div class="status-info">
                    <strong id="monitoringStatusText">Loading...</strong>
                </div>
                <div class="status-actions">
                    <button class="btn btn-success" id="startMonitoringBtn" onclick="startMonitoring()">
                        ‚ñ∂Ô∏è Start
                    </button>
                    <button class="btn btn-warning" id="stopMonitoringBtn" onclick="stopMonitoring()" style="display: none;">
                        ‚èπÔ∏è Stop
                    </button>
                </div>
            </div>

            <!-- Thresholds -->
            <div class="settings-card">
                <h3>‚ö†Ô∏è Alert Thresholds</h3>
                <p class="card-desc">Send alerts when containers exceed these resource limits.</p>
                
                <div class="form-row threshold-row">
                    <div class="form-group">
                        <label for="cpuThreshold">CPU Alert Threshold</label>
                        <div class="input-with-suffix">
                            <input type="number" id="cpuThreshold" value="80" min="0" max="100">
                            <span class="suffix">%</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="memoryThreshold">Memory Alert Threshold</label>
                        <div class="input-with-suffix">
                            <input type="number" id="memoryThreshold" value="85" min="0" max="100">
                            <span class="suffix">%</span>
                        </div>
                    </div>
                </div>

                <button class="btn btn-secondary" onclick="updateThresholds()">
                    üíæ Save Thresholds
                </button>
            </div>
        </div>
    </div>

    <!-- Maintenance Tab -->
    <div class="settings-tab-content" id="tab-maintenance" style="display: none;">
        <div class="settings-section">
            <div class="section-header">
                <h2>üßπ System Maintenance</h2>
                <p class="section-desc">Clean up unused Docker resources to free disk space.</p>
            </div>

            <div class="maintenance-grid">
                <div class="maintenance-card">
                    <div class="maintenance-icon">üì¶</div>
                    <h3>Stopped Containers</h3>
                    <p>Remove all stopped containers</p>
                    <button class="btn btn-warning" onclick="pruneContainers()">
                        üóëÔ∏è Prune Containers
                    </button>
                </div>

                <div class="maintenance-card">
                    <div class="maintenance-icon">üñºÔ∏è</div>
                    <h3>Unused Images</h3>
                    <p>Remove dangling and unused images</p>
                    <button class="btn btn-warning" onclick="pruneImages()">
                        üóëÔ∏è Prune Images
                    </button>
                </div>

                <div class="maintenance-card">
                    <div class="maintenance-icon">üíæ</div>
                    <h3>Unused Volumes</h3>
                    <p>Remove unused volumes (data loss possible!)</p>
                    <button class="btn btn-danger" onclick="pruneVolumes()">
                        üóëÔ∏è Prune Volumes
                    </button>
                </div>

                <div class="maintenance-card maintenance-card-full">
                    <div class="maintenance-icon">üßπ</div>
                    <h3>Full System Cleanup</h3>
                    <p>Remove all unused containers, images, and volumes at once</p>
                    <button class="btn btn-danger btn-lg" onclick="pruneAll()">
                        üßπ Prune Everything
                    </button>
                </div>
            </div>

            <!-- Images Browser -->
            <div class="settings-card">
                <h3>üì¶ Image Browser</h3>
                <p class="card-desc">View and manage Docker images on this host.</p>
                <button class="btn btn-secondary" onclick="showImagesModal()">
                    üì¶ View Images
                </button>
            </div>
        </div>
    </div>

    <!-- Account Tab -->
    <div class="settings-tab-content" id="tab-account" style="display: none;">
        <div class="settings-section">
            <div class="section-header">
                <h2>üë§ Account Settings</h2>
            </div>

            <div class="settings-card">
                <div class="account-info">
                    <div class="avatar">{{ current_user.username[0]|upper }}</div>
                    <div class="user-details">
                        <strong>{{ current_user.username }}</strong>
                        <span class="user-meta">Account created {{ current_user.created_at.strftime('%B %d, %Y') if current_user.created_at else 'N/A' }}</span>
                    </div>
                </div>
                
                <a href="{{ url_for('auth.change_password') }}" class="btn btn-secondary">
                    üîê Change Password
                </a>
            </div>
        </div>
    </div>

    <!-- Webhook Modal -->
    <div class="modal-overlay" id="webhookModal" style="display: none;" onclick="closeWebhookModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title" id="webhookModalTitle">‚ûï Add Webhook</div>
                <button class="modal-close" onclick="closeWebhookModal()">√ó</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="webhookId">
                
                <div class="form-group">
                    <label for="webhookName">Name</label>
                    <input type="text" id="webhookName" placeholder="e.g., Production Alerts" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="webhookType">Platform</label>
                        <select id="webhookType">
                            <option value="discord">Discord</option>
                            <option value="slack">Slack</option>
                            <option value="telegram">Telegram</option>
                            <option value="generic">Generic Webhook</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="webhookUrl">Webhook URL</label>
                    <input type="url" id="webhookUrl" placeholder="https://..." required>
                    <span class="form-hint">Discord: Settings ‚Üí Integrations ‚Üí Webhooks</span>
                </div>
                
                <h4>Alert Triggers</h4>
                <div class="checkbox-grid">
                    <label class="checkbox-card">
                        <input type="checkbox" id="alertStop" checked>
                        <span class="checkbox-label">
                            <span class="checkbox-icon">‚èπÔ∏è</span>
                            Container stopped
                        </span>
                    </label>
                    <label class="checkbox-card">
                        <input type="checkbox" id="alertStart">
                        <span class="checkbox-label">
                            <span class="checkbox-icon">‚ñ∂Ô∏è</span>
                            Container started
                        </span>
                    </label>
                    <label class="checkbox-card">
                        <input type="checkbox" id="alertHealth" checked>
                        <span class="checkbox-label">
                            <span class="checkbox-icon">‚ù§Ô∏è</span>
                            Health check failed
                        </span>
                    </label>
                </div>
                
                <h4>Resource Alerts</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="alertCpu">CPU threshold</label>
                        <div class="input-with-suffix">
                            <input type="number" id="alertCpu" value="90" min="0" max="100">
                            <span class="suffix">%</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="alertMemory">Memory threshold</label>
                        <div class="input-with-suffix">
                            <input type="number" id="alertMemory" value="90" min="0" max="100">
                            <span class="suffix">%</span>
                        </div>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="testWebhook()">üß™ Test</button>
                    <button class="btn btn-primary" onclick="saveWebhook()">üíæ Save Webhook</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Images Modal -->
    <div class="modal-overlay" id="imagesModal" style="display: none;" onclick="closeImagesModal(event)">
        <div class="modal modal-lg" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title">üì¶ Docker Images</div>
                <button class="modal-close" onclick="closeImagesModal()">√ó</button>
            </div>
            <div class="modal-body" id="imagesContent">
                <div class="loading">Loading images...</div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/settings.js') }}"></script>
{% endblock %}
