{% extends "base.html" %}

{% block title %}Dashboard - DockDash{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="page-header">
        <h1>ğŸ³ Docker Containers</h1>
        <div class="header-actions">
            <label class="toggle-switch">
                <input type="checkbox" id="showAllToggle" {% if show_all %}checked{% endif %}>
                <span class="toggle-slider"></span>
                <span class="toggle-label">Show stopped containers</span>
            </label>
            <button class="btn btn-secondary" onclick="refreshContainers()">
                ğŸ”„ Refresh
            </button>
        </div>
    </div>

    {% if not docker_available %}
    <div class="alert alert-warning">
        <strong>âš ï¸ Docker Not Available</strong>
        <p>Unable to connect to Docker daemon. Make sure the Docker socket is mounted correctly.</p>
    </div>
    {% endif %}

    <div class="info-bar">
        <span class="host-ip">ğŸŒ Host IP: <strong>{{ host_ip }}</strong></span>
        <span class="container-count">ğŸ“¦ Containers: <strong id="containerCount">{{ containers|length }}</strong></span>
    </div>

    <div class="container-grid" id="containerGrid">
        {% if containers %}
            {% for container in containers %}
            <div class="container-card status-{{ container.status }}">
                <div class="container-header">
                    <h3 class="container-name">{{ container.name }}</h3>
                    <span class="status-badge status-{{ container.status }}">{{ container.status }}</span>
                </div>
                
                <div class="container-details">
                    <div class="detail-row">
                        <span class="detail-label">ID:</span>
                        <span class="detail-value">{{ container.id }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Image:</span>
                        <span class="detail-value">{{ container.image }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Created:</span>
                        <span class="detail-value">{{ container.created }}</span>
                    </div>
                </div>

                {% if container.ports %}
                <div class="container-ports">
                    <h4>ğŸ”Œ Ports & URLs</h4>
                    {% for port in container.ports %}
                    <div class="port-item">
                        <span class="port-mapping">{{ port.container_port }} â†’ {{ port.host_port }}</span>
                        <a href="{{ port.url }}" target="_blank" class="port-link" title="Open in new tab">
                            {{ port.url }} ğŸ”—
                        </a>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="container-ports no-ports">
                    <p>No exposed ports</p>
                </div>
                {% endif %}

                <div class="container-actions">
                    {% if container.status == 'running' %}
                    <button class="btn btn-warning btn-sm" onclick="restartContainer('{{ container.id }}', '{{ container.name }}')">
                        ğŸ”„ Restart
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="stopContainer('{{ container.id }}', '{{ container.name }}')">
                        â¹ï¸ Stop
                    </button>
                    {% else %}
                    <button class="btn btn-success btn-sm" onclick="startContainer('{{ container.id }}', '{{ container.name }}')">
                        â–¶ï¸ Start
                    </button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <span class="empty-icon">ğŸ“¦</span>
                <h3>No containers found</h3>
                <p>{% if show_all %}There are no Docker containers on this host.{% else %}There are no running containers. Toggle "Show stopped containers" to see all.{% endif %}</p>
            </div>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.getElementById('showAllToggle').addEventListener('change', function() {
    const showAll = this.checked;
    window.location.href = '/dashboard?show_all=' + showAll;
});

function refreshContainers() {
    location.reload();
}

async function restartContainer(id, name) {
    if (!confirm(`Are you sure you want to restart ${name}?`)) return;
    
    try {
        const response = await fetch(`/api/container/${id}/restart`, { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
            showToast('success', data.message);
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast('error', data.error);
        }
    } catch (error) {
        showToast('error', 'Failed to restart container');
    }
}

async function stopContainer(id, name) {
    if (!confirm(`Are you sure you want to stop ${name}?`)) return;
    
    try {
        const response = await fetch(`/api/container/${id}/stop`, { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
            showToast('success', data.message);
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast('error', data.error);
        }
    } catch (error) {
        showToast('error', 'Failed to stop container');
    }
}

async function startContainer(id, name) {
    if (!confirm(`Are you sure you want to start ${name}?`)) return;
    
    try {
        const response = await fetch(`/api/container/${id}/start`, { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
            showToast('success', data.message);
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast('error', data.error);
        }
    } catch (error) {
        showToast('error', 'Failed to start container');
    }
}
</script>
{% endblock %}
