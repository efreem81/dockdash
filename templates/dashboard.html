{% extends "base.html" %}

{% block title %}Dashboard - DockDash{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="page-header">
        <h1>ğŸ³ Docker Containers</h1>
        <div class="header-actions">
            <div class="view-toggle">
                <button class="view-btn active" id="cardViewBtn" onclick="setView('card')" title="Card View">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <rect x="1" y="1" width="6" height="6" rx="1"/>
                        <rect x="9" y="1" width="6" height="6" rx="1"/>
                        <rect x="1" y="9" width="6" height="6" rx="1"/>
                        <rect x="9" y="9" width="6" height="6" rx="1"/>
                    </svg>
                </button>
                <button class="view-btn" id="tableViewBtn" onclick="setView('table')" title="Table View">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <rect x="1" y="2" width="14" height="2" rx="0.5"/>
                        <rect x="1" y="7" width="14" height="2" rx="0.5"/>
                        <rect x="1" y="12" width="14" height="2" rx="0.5"/>
                    </svg>
                </button>
            </div>
            <label class="toggle-switch">
                <input type="checkbox" id="showAllToggle" {% if show_all %}checked{% endif %}>
                <span class="toggle-slider"></span>
                <span class="toggle-label">Show stopped containers</span>
            </label>
            <button class="btn btn-secondary" onclick="checkAllImageUpdates()" id="checkUpdatesBtn" title="Check for image updates">
                â¬†ï¸ Check Updates
            </button>
            <button class="btn btn-secondary" onclick="scanAllVulnerabilities()" id="scanVulnBtn" title="Scan all images for vulnerabilities">
                ğŸ›¡ï¸ Scan CVEs
            </button>
            <button class="btn btn-secondary" onclick="refreshContainers()">
                ğŸ”„ Refresh
            </button>
        </div>
    </div>

    {% if not docker_available %}
    <div class="alert alert-warning">
        <strong>âš ï¸ Docker Not Available</strong>
        <p>Unable to connect to Docker daemon. Make sure the Docker socket is mounted correctly.</p>
    </div>
    {% endif %}

    <div class="info-bar">
        <span class="host-ip">ğŸŒ Host IP: <strong>{{ host_ip }}</strong></span>
        <span class="container-count">ğŸ“¦ Containers: <strong id="containerCount">{{ containers|length }}</strong></span>
        <span class="update-count" id="updateCount" style="display: none;">â¬†ï¸ Updates: <strong id="updateCountValue">0</strong></span>
        <span class="vuln-summary" id="vulnSummary">
            {% set total_critical = vuln_results.values()|selectattr('critical')|map(attribute='critical')|sum %}
            {% set total_high = vuln_results.values()|selectattr('high')|map(attribute='high')|sum %}
            {% if total_critical > 0 or total_high > 0 %}
            ğŸ›¡ï¸ CVEs: <strong class="{% if total_critical > 0 %}text-critical{% else %}text-high{% endif %}">{{ total_critical }}C / {{ total_high }}H</strong>
            {% elif vuln_results|length > 0 %}
            ğŸ›¡ï¸ <strong class="text-ok">No critical/high CVEs</strong>
            {% else %}
            ğŸ›¡ï¸ <span class="text-muted">Not scanned</span>
            {% endif %}
        </span>
    </div>

    <!-- Search and Controls Bar -->
    <div class="controls-bar">
        <div class="search-box">
            <span class="search-icon">ğŸ”</span>
            <input type="text" id="searchInput" placeholder="Search containers..." autocomplete="off">
            <button class="search-clear" id="searchClear" onclick="clearSearch()" aria-label="Clear search" style="display: none;">Ã—</button>
        </div>

        <div class="sort-controls">
            <label for="sortSelect">Sort</label>
            <select id="sortSelect" onchange="sortContainers()">
                <option value="name-asc" selected>Name (Aâ†’Z)</option>
                <option value="name-desc">Name (Zâ†’A)</option>
                <option value="status-asc">Status (running first)</option>
                <option value="status-desc">Status (running last)</option>
                <option value="image-asc">Image (Aâ†’Z)</option>
                <option value="image-desc">Image (Zâ†’A)</option>
                <option value="created-desc">Created (newest)</option>
                <option value="created-asc">Created (oldest)</option>
            </select>
        </div>

        <div class="page-size-controls">
            <label for="pageSizeSelect">Per page</label>
            <select id="pageSizeSelect" onchange="changePageSize()">
                <option value="10">10</option>
                <option value="25" selected>25</option>
                <option value="50">50</option>
                <option value="100">100</option>
                <option value="all">All</option>
            </select>
        </div>
    </div>

    <!-- Results info and pagination -->
    <div class="pagination-bar">
        <div class="results-info">
            Showing <span id="showingStart">1</span>-<span id="showingEnd">{{ containers|length }}</span> of <span id="totalFiltered">{{ containers|length }}</span> containers
        </div>
        <div class="pagination-controls" id="paginationControls">
            <button class="page-btn" id="prevPage" onclick="changePage(-1)" disabled>â† Prev</button>
            <span class="page-info">Page <span id="currentPage">1</span> of <span id="totalPages">1</span></span>
            <button class="page-btn" id="nextPage" onclick="changePage(1)">Next â†’</button>
        </div>
    </div>

    <!-- Card View -->
    <div class="container-grid" id="containerGrid">
        {% if containers %}
            {% for container in containers %}
            <div class="container-card status-{{ container.status }}" 
                 data-name="{{ container.name|lower }}"
                 data-status="{{ container.status }}"
                 data-image="{{ container.image|lower }}"
                 data-image-full="{{ container.image }}"
                 data-created="{{ container.created }}"
                 data-compose-project="{{ container.compose_project or '' }}"
                 data-id="{{ container.id }}">
                <div class="container-header">
                    <h3 class="container-name">{{ container.name }}</h3>
                    <div class="header-badges">
                        {% if container.vulnerabilities %}
                        <span class="vuln-badge {% if container.vulnerabilities.critical > 0 %}vuln-critical{% elif container.vulnerabilities.high > 0 %}vuln-high{% elif container.vulnerabilities.medium > 0 %}vuln-medium{% else %}vuln-low{% endif %}" 
                              title="Vulnerabilities: {{ container.vulnerabilities.critical }} Critical, {{ container.vulnerabilities.high }} High, {{ container.vulnerabilities.medium }} Medium, {{ container.vulnerabilities.low }} Low">
                            ğŸ›¡ï¸ {% if container.vulnerabilities.critical > 0 %}{{ container.vulnerabilities.critical }}C{% endif %}{% if container.vulnerabilities.high > 0 %} {{ container.vulnerabilities.high }}H{% endif %}{% if container.vulnerabilities.critical == 0 and container.vulnerabilities.high == 0 and container.vulnerabilities.total > 0 %}{{ container.vulnerabilities.total }}{% endif %}{% if container.vulnerabilities.total == 0 %}âœ“{% endif %}
                        </span>
                        {% endif %}
                        {% if container.health_status %}
                        <span class="health-badge health-{{ container.health_status }}" title="Health: {{ container.health_status }}">
                            {% if container.health_status == 'healthy' %}ğŸ’š{% elif container.health_status == 'unhealthy' %}â¤ï¸{% else %}ğŸ’›{% endif %}
                        </span>
                        {% endif %}
                        <span class="update-badge" data-image="{{ container.image }}" style="display: none;" title="Update available">
                            â¬†ï¸ Update
                        </span>
                        <span class="status-badge status-{{ container.status }}">{{ container.status }}</span>
                    </div>
                </div>
                
                <div class="container-details">
                    <div class="detail-row">
                        <span class="detail-label">Image:</span>
                        <span class="detail-value image-value" data-image="{{ container.image }}">
                            {{ container.image }}{% if container.image_digest %}<span class="image-digest" title="Image digest: sha256:{{ container.image_digest }}...">@{{ container.image_digest }}</span>{% endif %}
                            <span class="image-update-icon" style="display: none;" title="Checking for updates...">ğŸ”„</span>
                        </span>
                    </div>
                    {% if container.image_age %}
                    <div class="detail-row">
                        <span class="detail-label">Image Age:</span>
                        <span class="detail-value image-age" title="Image created: {{ container.image_created }}">ğŸ“¦ {{ container.image_age }}</span>
                    </div>
                    {% endif %}
                    {% if container.compose_project %}
                    <div class="detail-row">
                        <span class="detail-label">Project:</span>
                        <span class="detail-value compose-project">ğŸ“¦ {{ container.compose_project }}</span>
                    </div>
                    {% endif %}
                    {% if container.uptime_human %}
                    <div class="detail-row">
                        <span class="detail-label">Uptime:</span>
                        <span class="detail-value">â±ï¸ {{ container.uptime_human }}</span>
                    </div>
                    {% endif %}
                    {% if container.restart_count > 0 %}
                    <div class="detail-row">
                        <span class="detail-label">Restarts:</span>
                        <span class="detail-value restart-count">ğŸ” {{ container.restart_count }}</span>
                    </div>
                    {% endif %}
                    <div class="detail-row">
                        <span class="detail-label">Created:</span>
                        <span class="detail-value">{{ container.created }}</span>
                    </div>
                </div>

                <!-- Stats placeholder -->
                <div class="container-stats" id="stats-{{ container.id }}" style="display: none;">
                    <div class="stats-row">
                        <span class="stat-label">CPU:</span>
                        <span class="stat-value cpu-stat">-</span>
                        <div class="stat-bar"><div class="stat-fill cpu-fill"></div></div>
                    </div>
                    <div class="stats-row">
                        <span class="stat-label">Memory:</span>
                        <span class="stat-value mem-stat">-</span>
                        <div class="stat-bar"><div class="stat-fill mem-fill"></div></div>
                    </div>
                </div>

                {% if container.ports %}
                <div class="container-ports">
                    <h4>ğŸ”— Links</h4>
                    {% for port in container.ports %}
                    <div class="port-item">
                        <a href="{{ port.url }}"
                           target="_blank"
                           rel="noopener noreferrer"
                           class="port-link probe-link"
                           data-host="{{ host_ip }}"
                           data-port="{{ port.host_port }}"
                           data-container-port="{{ port.container_port }}"
                           title="Open in new tab">
                            <span class="link-scheme">http</span>
                            <span class="link-port">:{{ port.host_port }}</span>
                        </a>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="container-ports no-ports">
                    <p>No exposed ports</p>
                </div>
                {% endif %}

                <div class="container-actions">
                    {% if container.status == 'running' %}
                    <button class="btn btn-warning btn-sm" onclick="restartContainer('{{ container.id }}', '{{ container.name }}')" title="Restart">
                        ğŸ”„
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="stopContainer('{{ container.id }}', '{{ container.name }}')" title="Stop">
                        â¹ï¸
                    </button>
                    <button class="btn btn-info btn-sm" onclick="toggleStats('{{ container.id }}')" title="Stats">
                        ğŸ“Š
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="openExec('{{ container.id }}', '{{ container.name }}')" title="Execute Command">
                        ğŸ’»
                    </button>
                    {% else %}
                    <button class="btn btn-success btn-sm" onclick="startContainer('{{ container.id }}', '{{ container.name }}')" title="Start">
                        â–¶ï¸
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="removeContainer('{{ container.id }}', '{{ container.name }}')" title="Remove">
                        ğŸ—‘ï¸
                    </button>
                    {% endif %}
                    <button class="btn btn-secondary btn-sm" onclick="openLogs('{{ container.id }}', '{{ container.name }}')" title="Logs">
                        ğŸ“œ
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="openInspect('{{ container.id }}', '{{ container.name }}')" title="Inspect">
                        ğŸ”
                    </button>
                    <button class="btn btn-info btn-sm" onclick="recreateContainer('{{ container.id }}', '{{ container.name }}')" title="Recreate (pull latest & restart)">
                        ğŸ”ƒ
                    </button>
                </div>
            </div>
            {% endfor %}
        {% endif %}
        <div class="empty-state" id="emptyState" style="display: none;">
            <span class="empty-icon">ğŸ“¦</span>
            <h3 id="emptyStateTitle">No containers found</h3>
            <p id="emptyStateText">{% if show_all %}There are no Docker containers on this host.{% else %}There are no running containers. Toggle "Show stopped containers" to see all.{% endif %}</p>
        </div>
        <div class="empty-state" id="noResultsState" style="display: none;">
            <span class="empty-icon">ğŸ”</span>
            <h3>No matching containers</h3>
            <p>Try adjusting your search terms.</p>
        </div>
    </div>

    <!-- Table View -->
    <div class="container-table-wrapper" id="containerTable" style="display: none;">
        {% if containers %}
        <table class="container-table">
            <thead>
                <tr>
                    <th class="sortable" data-sort="name" onclick="sortByColumn('name')">
                        Container <span class="sort-icon" id="sort-name">â†•</span>
                    </th>
                    <th class="sortable" data-sort="status" onclick="sortByColumn('status')">
                        Status <span class="sort-icon" id="sort-status">â†•</span>
                    </th>
                    <th class="sortable" data-sort="image" onclick="sortByColumn('image')">
                        Image <span class="sort-icon" id="sort-image">â†•</span>
                    </th>
                    <th>Actions</th>
                    <th>Links</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                {% for container in containers %}
                <tr class="status-row-{{ container.status }}"
                    data-name="{{ container.name|lower }}"
                    data-status="{{ container.status }}"
                    data-image="{{ container.image|lower }}"
                    data-image-full="{{ container.image }}"
                    data-created="{{ container.created }}"
                    data-id="{{ container.id }}">
                    <td class="cell-name">
                        <strong>{{ container.name }}</strong>
                    </td>
                    <td>
                        <span class="status-badge status-{{ container.status }}">{{ container.status }}</span>
                    </td>
                    <td class="cell-image">
                        <span class="image-value" data-image="{{ container.image }}">
                            {{ container.image }}{% if container.image_digest %}<span class="image-digest" title="sha256:{{ container.image_digest }}...">@{{ container.image_digest }}</span>{% endif %}
                            <span class="update-badge table-update-badge" style="display: none;" title="Update available">â¬†ï¸</span>
                            {% if container.image_age %}<span class="image-age-badge" title="Image created: {{ container.image_created }}">{{ container.image_age }}</span>{% endif %}
                        </span>
                    </td>
                    <td class="cell-actions">
                        {% if container.status == 'running' %}
                        <button class="btn btn-warning btn-xs" onclick="restartContainer('{{ container.id }}', '{{ container.name }}')" title="Restart">
                            ğŸ”„
                        </button>
                        <button class="btn btn-danger btn-xs" onclick="stopContainer('{{ container.id }}', '{{ container.name }}')" title="Stop">
                            â¹ï¸
                        </button>
                        {% else %}
                        <button class="btn btn-success btn-xs" onclick="startContainer('{{ container.id }}', '{{ container.name }}')" title="Start">
                            â–¶ï¸
                        </button>
                        {% endif %}
                        <button class="btn btn-secondary btn-xs" onclick="openLogs('{{ container.id }}', '{{ container.name }}')" title="Logs">
                            ğŸ“œ
                        </button>
                    </td>
                    <td class="cell-links">
                        {% if container.ports %}
                        <div class="links-strip">
                            {% for port in container.ports %}
                            <a href="{{ port.url }}"
                               target="_blank"
                               rel="noopener noreferrer"
                               class="table-link probe-link"
                               data-host="{{ host_ip }}"
                               data-port="{{ port.host_port }}"
                               data-container-port="{{ port.container_port }}"
                               title="Open in new tab">
                                <span class="link-scheme">http</span><span class="link-port">:{{ port.host_port }}</span>
                            </a>
                            {% endfor %}
                        </div>
                        {% else %}
                            â€”
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div class="empty-state" id="tableNoResults" style="display: none;">
            <span class="empty-icon">ğŸ”</span>
            <h3>No matching containers</h3>
            <p>Try adjusting your search terms.</p>
        </div>
        {% else %}
            <div class="empty-state">
                <span class="empty-icon">ğŸ“¦</span>
                <h3>No containers found</h3>
                <p>{% if show_all %}There are no Docker containers on this host.{% else %}There are no running containers. Toggle "Show stopped containers" to see all.{% endif %}</p>
            </div>
        {% endif %}
    </div>

    <!-- Logs modal -->
    <div class="modal-overlay" id="logsModal" style="display: none;" onclick="closeLogs(event)">
        <div class="modal" role="dialog" aria-modal="true" aria-label="Container logs" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title" id="logsTitle">ğŸ“œ Logs</div>
                <button class="modal-close" onclick="closeLogs()" aria-label="Close">Ã—</button>
            </div>
            <div class="modal-toolbar">
                <label class="checkbox-inline">
                    <input type="checkbox" id="logsFollow" checked>
                    Follow
                </label>

                <label class="modal-field">
                    Tail
                    <select id="logsTail" onchange="refreshLogs()">
                        <option value="100">100</option>
                        <option value="200" selected>200</option>
                        <option value="500">500</option>
                        <option value="1000">1000</option>
                    </select>
                </label>

                <button class="btn btn-secondary btn-xs" onclick="refreshLogs()" title="Refresh logs">Refresh</button>
                <button class="btn btn-secondary btn-xs" onclick="copyLogs()" title="Copy logs">Copy</button>
            </div>

            <pre class="logs-output" id="logsOutput"></pre>
        </div>
    </div>

    <!-- Exec modal -->
    <div class="modal-overlay" id="execModal" style="display: none;" onclick="closeExec(event)">
        <div class="modal" role="dialog" aria-modal="true" aria-label="Execute command" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title" id="execTitle">ğŸ’» Execute Command</div>
                <button class="modal-close" onclick="closeExec()" aria-label="Close">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="execCommand">Command</label>
                    <input type="text" id="execCommand" placeholder="ls -la" class="exec-input" onkeydown="if(event.key==='Enter')runExec()">
                </div>
                <div class="form-group">
                    <label for="execWorkdir">Working Directory (optional)</label>
                    <input type="text" id="execWorkdir" placeholder="/app" class="exec-input">
                </div>
                <button class="btn btn-primary" onclick="runExec()">â–¶ï¸ Run</button>
            </div>
            <pre class="exec-output" id="execOutput"></pre>
        </div>
    </div>

    <!-- Inspect modal -->
    <div class="modal-overlay" id="inspectModal" style="display: none;" onclick="closeInspect(event)">
        <div class="modal modal-lg" role="dialog" aria-modal="true" aria-label="Container details" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title" id="inspectTitle">ğŸ” Container Details</div>
                <button class="modal-close" onclick="closeInspect()" aria-label="Close">Ã—</button>
            </div>
            <div class="modal-body" id="inspectContent">
                <div class="inspect-tabs">
                    <button class="tab-btn active" onclick="showInspectTab('env')">Environment</button>
                    <button class="tab-btn" onclick="showInspectTab('mounts')">Mounts</button>
                    <button class="tab-btn" onclick="showInspectTab('networks')">Networks</button>
                    <button class="tab-btn" onclick="showInspectTab('labels')">Labels</button>
                </div>
                <div class="inspect-tab-content" id="inspectTabContent"></div>
            </div>
        </div>
    </div>

    <!-- Bottom pagination -->
    <div class="pagination-bar bottom" id="bottomPagination">
        <div class="pagination-controls">
            <button class="page-btn" id="prevPageBottom" onclick="changePage(-1)" disabled>â† Prev</button>
            <span class="page-info">Page <span id="currentPageBottom">1</span> of <span id="totalPagesBottom">1</span></span>
            <button class="page-btn" id="nextPageBottom" onclick="changePage(1)">Next â†’</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}
